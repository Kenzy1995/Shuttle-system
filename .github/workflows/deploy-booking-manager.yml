name: Deploy Booking Manager to Cloud Run

on:
  push:
    paths:
      - 'booking-manager/**'
    branches: [ main ]

env:
  PROJECT_ID: '${{ secrets.GCP_PROJECT_ID }}'
  SERVICE: booking-manager
  REGION: asia-east1

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Google Auth
      id: auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

    - name: Set project
      run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure Docker auth
      run: |
        gcloud auth configure-docker gcr.io --quiet

    - name: Build Docker image
      run: |
        cd booking-manager
        docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE }} .

    - name: Push Docker image
      run: |
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE }}

    - name: Deploy to Cloud Run
      env:
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASS: ${{ secrets.SMTP_PASS }}
        FIREBASE_RTDB_URL: ${{ secrets.FIREBASE_RTDB_URL }}
      run: |
        gcloud run deploy ${{ env.SERVICE }} \
          --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE }} \
          --region ${{ env.REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --service-account=forte-booking-system@forte-booking-system.iam.gserviceaccount.com \
          --memory=2Gi \
          --cpu=2 \
          --max-instances=10 \
          --timeout=300s \
          --set-env-vars "SMTP_HOST=smtp.gmail.com,SMTP_PORT=587,SMTP_USER=$SMTP_USER,SMTP_PASS=$SMTP_PASS,FIREBASE_RTDB_URL=$FIREBASE_RTDB_URL"

    - name: Cleanup old revisions (keep only latest 1)
      run: |
        echo "清理舊的 Cloud Run revisions..."
        REVISIONS=$(gcloud run revisions list --service=${{ env.SERVICE }} --region=${{ env.REGION }} --format="value(metadata.name)" --project=${{ secrets.GCP_PROJECT_ID }} --sort-by=~metadata.creationTimestamp | tail -n +2)
        if [ -n "$REVISIONS" ]; then
          echo "$REVISIONS" | while read revision; do
            echo "刪除舊 revision: $revision"
            gcloud run revisions delete "$revision" --region=${{ env.REGION }} --quiet --project=${{ secrets.GCP_PROJECT_ID }} || true
          done
        else
          echo "沒有舊 revisions 需要清理"
        fi

    - name: Cleanup old images (keep only latest 1)
      run: |
        echo "清理舊的 Container Registry 映像..."
        CURRENT_IMAGE=$(gcloud run services describe ${{ env.SERVICE }} --region=${{ env.REGION }} --format="value(spec.template.spec.containers[0].image)" --project=${{ secrets.GCP_PROJECT_ID }})
        if [ -n "$CURRENT_IMAGE" ] && [[ "$CURRENT_IMAGE" == *"@sha256:"* ]]; then
          CURRENT_DIGEST=$(echo "$CURRENT_IMAGE" | sed 's/.*@sha256://')
          echo "當前使用的映像 digest: $CURRENT_DIGEST"
          ALL_IMAGES=$(gcloud container images list-tags gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE }} --format="value(digest)" --project=${{ secrets.GCP_PROJECT_ID }})
          echo "$ALL_IMAGES" | while read digest; do
            if [ -n "$digest" ] && [ "$digest" != "sha256:$CURRENT_DIGEST" ]; then
              echo "刪除舊映像: $digest"
              gcloud container images delete gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE }}@$digest --quiet --project=${{ secrets.GCP_PROJECT_ID }} || true
            fi
          done
        else
          echo "無法確定當前映像，跳過清理"
        fi

    - name: Show Service URL
      run: |
        echo "Service deployed at: https://${{ env.SERVICE }}-${{ secrets.GCP_PROJECT_ID }}.a.run.app"
