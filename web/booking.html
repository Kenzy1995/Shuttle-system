<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title data-i18n="title">飯店服務-免費接駁車預約</title>
  <style>
    :root{
      --primary:#A98570;
      --secondary:#8f7147;
      --bg:#f9f5ef;
      --card:#fff;
      --text:#333;
      --muted:#777;
      --disabled:#c7c7c7;
      --radius:14px;
      --shadow:0 2px 8px rgba(0,0,0,.08);
      --shadow-lg:0 10px 30px rgba(0,0,0,.15);
      --green:#2e7d32;
      --red:#b00020;
      --gray:#9e9e9e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;
      overflow-x:hidden;
      -webkit-text-size-adjust:100%;
      display:flex;flex-direction:column;
    }
    img, iframe{max-width:100%;}
    a{color:inherit; text-decoration:none}

    .navbar{
      position:sticky;top:0;z-index:50;
      display:flex;align-items:center;
      padding:12px 16px;background:var(--card);box-shadow:0 1px 4px rgba(0,0,0,.06)
    }
    .brand{display:flex;align-items:center;gap:10px;margin-right: 30px;}
    .brand img{height:28px;width:auto;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .brand-title{font-weight:800;font-size:18px}

    .nav-right{display:flex;align-items:center;gap:12px;margin-left:auto}
    .lang-wrap span { font-size: 12px; }
    .nav-links{display:flex;gap:8px}
    .nav-links button{
      background:none;border:none;padding:8px 10px;border-radius:10px;cursor:pointer;
      font-size:14px
    }
    .nav-links button.active,.nav-links button:hover{color:var(--primary);background:#f3eee6}

    select{
      appearance:none;padding:8px 28px 8px 10px;border:1px solid #ddd;border-radius:10px;background:white url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="10" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>') no-repeat right 8px center/14px
    }

    .page{display:none;padding:20px;max-width:980px;margin:0 auto;flex:1}
    .page.active{display:block}

    .wizard-fixed{ width:100%; }
    @media (min-width: 1024px){
      .wizard-fixed{ width:66vw; min-width:620px; max-width:920px; margin-left:auto; margin-right:auto; }
    }

    .hero{
      max-width:840px;margin:18px auto 16px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:24px 20px;text-align:center
    }
    .hero h1{margin:0 0 12px;font-size:30px;font-weight:900}
    .hero p{margin:0;color:var(--muted)}

    .button{
      display:inline-block;min-width:160px;
      border:none;border-radius:14px;padding:14px 18px;font-size:16px;font-weight:700;cursor:pointer;background:var(--primary);color:#fff;
      transition:transform .06s ease,filter .2s ease
    }
    .button:active{transform:translateY(1px)}
    .btn-ghost{background:#eee;color:#333}

    .grid{display:grid;gap:14px}
    .card{ background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:18px }
    .card h2{margin:0 0 12px;font-size:20px;font-weight:800;text-align:center}
    .station-page .card h2 { text-align: left; }

    .field{margin:8px 0}
    .label{display:block;margin-bottom:6px;font-weight:700}
    .hint{font-size:12px;color:var(--muted)}

    .input,.select,.readonly{ width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:12px;background:#fff;font-size:16px }
    .readonly{background:#f4f4f4;color:#666}

    .error{color:#b00020;font-size:13px;margin-top:6px;display:none}

    .options{display:flex;flex-direction:column;gap:10px}
    .opt-btn{
      text-align:left;padding:14px 16px;border:1px solid #e7e7e7;border-radius:12px;background:#fff;font-weight:800;color:var(--primary);cursor:pointer;
      font-size:18px;
    }
    .opt-btn:hover{box-shadow:var(--shadow)}
    .opt-btn.active{outline:3px solid rgba(169,133,112,.25)}
    .opt-btn.disabled{color:#bbb;background:#f7f7f7;border-color:#eee;cursor:not-allowed}

    .actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:8px}
    .actions.row{flex-direction:row}
    .actions.col{flex-direction:column}

    /* 覆蓋層 */
    .overlay{ position:fixed;inset:0;background:rgba(255,255,255,.94);display:none;align-items:center;justify-content:center;z-index:9999; pointer-events:none }
    .overlay.show{display:flex; pointer-events:auto}
    .spinner{width:48px;height:48px;border-radius:50%;border:4px solid #eee;border-top:4px solid var(--primary);animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .overlay-card{background:#fff;border-radius:16px;box-shadow:var(--shadow-lg);padding:22px;max-width:680px;text-align:left}
    .overlay-card h3{margin:0 0 8px;font-size:20px}

    @keyframes shake {0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}
    .shake{animation:shake .5s ease-in-out}

    .query-form{display:flex;flex-direction:column;gap:14px}

    .footer{ background:#f5f5f5;color:#666;text-align:center;padding:20px;margin-top:auto;border-top:1px solid #e0e0e0;width:100%; }

    /* 手機底部導覽（白字） */
    .mobile-tabbar{ position:fixed;left:0;right:0;bottom:0;display:none;z-index:40; background:var(--primary);border-top:1px solid #e9e9e9;box-shadow:0 -2px 12px rgba(0,0,0,.06) }
    .mobile-tabbar .bar{display:grid;grid-template-columns:repeat(5,1fr);gap:0}
    .mobile-tabbar button{ appearance:none;border:none;background:none;padding:12px 6px;font-size:16px;color:#fff;font-weight:700;opacity:.85 }
    .mobile-tabbar button.active{opacity:1;text-decoration:underline}

    /* 回到頂端按鈕 */
    #backToTop{
      position:fixed;right:18px;bottom:24px;z-index:1000;display:none;width:44px;height:44px;border:none;border-radius:50%;cursor:pointer;background:#0009;color:#fff;font-size:22px;line-height:44px;text-align:center
    }
    #backToTop:hover{filter:brightness(1.2)}
    @media (max-width: 768px){ #backToTop{ bottom:96px; } }

    /* 成功動畫（3秒） */
    .success-animation{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10000;background:rgba(255,255,255,.95);border-radius:16px;padding:30px;box-shadow:var(--shadow-lg);display:none;align-items:center;justify-content:center;flex-direction:column;pointer-events:none}
    .success-animation.show{display:flex;animation:fadeInOut 3s ease-in-out;pointer-events:auto}

    /* 打勾圖示：綠底白勾 */
    .checkmark{width:80px;height:80px;border-radius:50%;display:block;stroke:#4CAF50;stroke-width:2;stroke-miterlimit:10;margin:20px auto;box-shadow:inset 0 0 0 0 #4CAF50;animation:fill .4s ease-in-out .4s forwards,scale .3s ease-in-out .9s both}
    .checkmark__circle{stroke-dasharray:166;stroke-dashoffset:166;stroke:#4CAF50;stroke-width:2;stroke-miterlimit:10;fill:none;animation:stroke .6s cubic-bezier(.65,0,.45,1) forwards}
    .checkmark__check{transform-origin:50% 50%;stroke-dasharray:48;stroke-dashoffset:48;stroke:#fff;stroke-width:3;stroke-linecap:round;stroke-linejoin:round;vector-effect:non-scaling-stroke;animation:stroke .3s cubic-bezier(.65,0,.45,1) .8s forwards}

    @keyframes stroke{100%{stroke-dashoffset:0}}
    @keyframes scale{0%,100%{transform:none}50%{transform:scale3d(1.1,1.1,1)}}
    @keyframes fill{100%{box-shadow:inset 0 0 0 40px #4CAF50}}
    @keyframes fadeInOut{0%{opacity:0}20%{opacity:1}80%{opacity:1}100%{opacity:0}}

    /* 車票卡片 */
    .ticket-card { position:relative; background: white; border-radius: 16px; box-shadow: var(--shadow-lg); padding: 20px; margin: 20px auto; max-width: 820px; width: 100%; }
    .ticket-card.expired{filter:grayscale(1);opacity:.7}
    .status-pill{position:absolute;left:12px;top:12px;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:800;color:#fff}
    .status-booked{background:var(--green)}
    .status-cancelled{background:var(--red)}
    .status-rejected{background:#d2691e}
    .status-boarded{background:#1976d2}
    .status-expired{background:var(--gray)}

    .ticket-header { text-align: center; margin-bottom: 24px; border-bottom: 2px solid var(--primary); padding-bottom: 16px; }
    .ticket-header h2 { margin: 0; font-size: 28px; font-weight: 900; color: var(--primary); }

    .ticket-close{
      position:absolute;right:12px;top:12px;width:36px;height:36px;border-radius:50%;border:none;background:#00000022;color:#333;font-size:18px;cursor:pointer;line-height:36px;text-align:center
    }

    .ticket-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
    .ticket-qr { text-align: center; padding: 20px; background: #f9f9f9; border-radius: 12px; min-height: 200px; }
    .ticket-qr img { width: 200px; height: 200px; border-radius: 8px; border: 1px solid #eee; background: #fff; object-fit: contain; }
    .ticket-info { display: flex; flex-direction: column; gap: 12px; }
    .ticket-field { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .ticket-field:last-child { border-bottom: none; }
    .ticket-label { font-weight: 800; color: var(--text); min-width: 120px; font-size: 18px; }
    .ticket-value { flex: 1; text-align: right; color: var(--muted); font-size: 18px; overflow-wrap: anywhere; word-break: break-word; }
    .ticket-actions { margin-top: 24px; display: flex; gap: 12px; justify-content: center; flex-direction: row-reverse; }

    .date-group{margin-bottom:20px;background:#fff;border-radius:14px;box-shadow:var(--shadow)}
    .date-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee;cursor:pointer}
    .date-title{font-weight:900}
    .date-count{color:#666;font-size:13px}
    .tickets-row{display:flex;gap:12px;padding:14px;overflow-x:auto;scroll-snap-type:x mandatory}
    .tickets-row .ticket-card{scroll-snap-align:start;flex:0 0 auto}

    .check-date-card.wizard-fixed{}
    .ticket-page .ticket-card{ max-width: 1000px; width:100%; }

    /* === 手機版 === */
    @media (max-width: 768px) {
      .ticket-card { width: 95%; max-width: 95%; box-sizing: border-box; margin: 0 auto; padding: 14px; overflow: hidden; }
      .ticket-content { display: flex; flex-direction: column; align-items: center; gap: 12px; }
      .ticket-info { width: 100%; word-wrap: break-word; }
      .ticket-qr img { width: 160px; height: 160px; max-width: 100%; }
      .hero .actions { justify-content: center !important; }
      .footer { font-size: 70%; padding: 15px 10px; }
      .tickets-row{flex-direction:column;overflow-x:hidden}
      .ticket-card{width:100%;max-width:100%}
    }

    #step6 .field { margin: 4px 0; }
    #step6 .label, #step6 .readonly { line-height: 1.2; }

    @media (max-width: 768px) {
      html, body { width: 100%; max-width: 100%; overflow-x: hidden; }
      .page, .card, .ticket-card { width: 100%; max-width: 100%; margin: 0 auto; box-sizing: border-box; }
      .nav-links { display: none; }
      .mobile-tabbar { display: block; }
      body { padding-bottom: 70px; }
      .navbar { justify-content: space-between; }
      .brand { margin-right: 0; }
      .actions { display: flex !important; flex-direction: row !important; justify-content: space-between !important; align-items: center !important; width: 100%; max-width: 340px; margin: 10px auto 0; gap: 10px; }
      .actions button { flex: 1; min-width: 120px; max-width: 160px; font-size: 15px; }
      .actions.has-three { flex-direction: column !important; align-items: center !important; justify-content: center !important; }
      .actions.has-three button { width: 80%; max-width: 320px; }
      .ticket-card { margin: 0 auto 20px; padding: 16px; overflow: visible; }
      .ticket-actions { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; width: 100%; margin-top: 16px; }
      .ticket-actions:not(.has-three) button { flex: 1; min-width: 140px; max-width: 160px; font-size: 15px; }
      .ticket-actions.has-three { flex-direction: column; align-items: center; }
      .ticket-actions.has-three button:nth-child(1),
      .ticket-actions.has-three button:nth-child(2) { width: 45%; max-width: 180px; }
      .ticket-actions.has-three button:nth-child(3) { width: 80%; max-width: 300px; }
    }

    .badge-alert{
      position:absolute; right:60px; top:12px;
      width:28px;height:28px;border-radius:50%;border:none;background:#ffcc80;color:#8a4b08;font-weight:900;cursor:pointer;
    }
  </style>
</head>
<body>
  <!-- 頂部導覽 -->
  <header class="navbar">
    <div class="brand">
      <img src="/images/logo.png" alt="logo" />
      <div class="brand-title" data-i18n="brand">飯店服務</div>
    </div>

    <div class="nav-links">
      <button id="nav-reservation" class="active" onclick="showPage('reservation')" data-i18n="navReservation">立即預約</button>
      <button id="nav-check" onclick="showPage('check')" data-i18n="navCheck">我的預約</button>
      <button id="nav-capacity" onclick="showPage('capacity')" data-i18n="navCapacity">查詢班次</button>
      <button id="nav-station" onclick="showPage('station')" data-i18n="navStation">停靠站點</button>
      <button id="nav-contact" onclick="showPage('contact')" data-i18n="navContact">回官網</button>
    </div>

    <div class="nav-right">
      <div class="lang-wrap">
        <span>Language</span>
        <select id="languageSelect" onchange="onLanguageChange(this.value)">
          <option value="zh" selected>中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="ko">한국어</option>
        </select>
      </div>
    </div>
  </header>

  <!-- 手機底部導覽 -->
  <nav class="mobile-tabbar">
    <div class="bar">
      <button id="m-reservation" class="active" onclick="showPage('reservation')" data-i18n="navReservation">立即預約</button>
      <button id="m-check" onclick="showPage('check')" data-i18n="navCheck">我的預約</button>
      <button id="m-capacity" onclick="showPage('capacity')" data-i18n="navCapacity">查詢班次</button>
      <button id="m-station" onclick="showPage('station')" data-i18n="navStation">停靠站點</button>
      <button id="m-contact" onclick="showPage('contact')" data-i18n="navContact">回官網</button>
    </div>
  </nav>

  <!-- 回到頂端 -->
  <button id="backToTop" title="Back to top" onclick="window.scrollTo({top:0,behavior:'smooth'})">↑</button>

  <!-- 預約流程 -->
  <main id="reservation" class="page active">
    <section id="homeHero" class="hero">
      <h1 data-i18n="heroTitle">免費接駁</h1>
      <div class="actions" style="margin-top:8px">
        <button class="button" onclick="startBooking()" data-i18n="bookNow">立即預約</button>
      </div>
      <div style="margin-top:16px">
        <img src="/images/時刻表.webp" alt="時刻表" style="width:100%;max-width:820px;border-radius:14px;box-shadow:var(--shadow)"/>
      </div>
    </section>

    <!-- Step 1：方向 -->
    <section id="step1" class="card wizard-fixed" style="display:none">
      <h2 data-i18n="step1Title">選擇方向</h2>
      <div class="field">
        <label class="label" data-i18n="labelDirection">請選擇方向<span style="color:#b00020">*</span></label>
        <div id="directionList" class="options"></div>
      </div>
      <div class="hint" data-i18n="directionHint">去程固定由飯店出發，回程終點為飯店</div>
      <div class="actions">
        <button class="button btn-ghost" onclick="restart()" data-i18n="requery">重新查詢</button>
      </div>
    </section>

    <!-- Step 2：日期 -->
    <section id="step2" class="card wizard-fixed" style="display:none">
      <h2 data-i18n="step2Title">選擇日期</h2>
      <div class="field">
        <label class="label" data-i18n="labelDate">請選擇日期<span style="color:#b00020">*</span></label>
        <div id="dateList" class="options"></div>
      </div>
      <div class="actions">
        <button class="button btn-ghost" onclick="goStep(1)" data-i18n="back">返回</button>
        <button class="button btn-ghost" onclick="restart()" data-i18n="requery">重新查詢</button>
      </div>
    </section>

    <!-- Step 3：站點 -->
    <section id="step3" class="card wizard-fixed" style="display:none">
      <h2 data-i18n="step3Title">選擇站點</h2>
      <div class="field">
        <label class="label" data-i18n="labelFixedStation">固定站點</label>
        <input id="fixedStation" class="readonly" type="text" readonly value="福泰大飯店 Forte Hotel" />
      </div>
      <div class="field">
        <label class="label" data-i18n="labelStation">請選擇站點<span style="color:#b00020">*</span></label>
        <div id="stationList" class="options"></div>
      </div>
      <div class="actions">
        <button class="button btn-ghost" onclick="goStep(2)" data-i18n="back">返回</button>
        <button class="button btn-ghost" onclick="restart()" data-i18n="requery">重新查詢</button>
      </div>
    </section>

    <!-- Step 4：班次 -->
    <section id="step4" class="card wizard-fixed" style="display:none">
      <h2 data-i18n="step4Title">選擇班次</h2>
      <div class="field">
        <label class="label" data-i18n="labelSchedule">請選擇班次<span style="color:#b00020">*</span></label>
        <div id="scheduleList" class="options"></div>
        <div class="hint" data-i18n="scheduleHint">點選班次以繼續</div>
      </div>
      <div class="actions">
        <button class="button btn-ghost" onclick="goStep(3)" data-i18n="back">返回</button>
        <button id="btnStep4Restart" class="button btn-ghost" onclick="restart()" data-i18n="requery">重新查詢</button>
      </div>
    </section>

    <!-- Step 5：旅客資料 -->
    <section id="step5" class="card wizard-fixed" style="display:none">
      <h2 data-i18n="step5Title">旅客資料填寫</h2>
      <div class="field">
        <label class="label" data-i18n="labelIdentity">請選擇您的身分<span style="color:#b00020">*</span></label>
        <select id="identitySelect" class="select" onchange="onIdentityChange()">
          <option value="hotel" selected data-i18n="idHotel">住宿貴賓</option>
          <option value="dining" data-i18n="idDining">用餐貴賓</option>
        </select>
        <div id="identityErr" class="error" data-i18n="errIdentity">請選擇您的身分</div>
      </div>

      <div id="hotelDates" class="field" style="display:none">
        <label class="label" data-i18n="labelCheckIn">入住日期<span style="color:#b00020">*</span></label>
        <input id="checkInDate" type="date" class="input" />
      </div>
      <div id="hotelDates2" class="field" style="display:none">
        <label class="label" data-i18n="labelCheckOut">退房日期<span style="color:#b00020">*</span></label>
        <input id="checkOutDate" type="date" class="input" />
      </div>

      <div id="diningDateDiv" class="field" style="display:none">
        <label class="label" data-i18n="labelDiningDate">用餐日期<span style="color:#b00020">*</span></label>
        <input id="diningDate" type="date" class="input" />
      </div>

      <div id="roomNumberDiv" class="field" style="display:none">
        <label class="label" data-i18n="labelRoom">房號<span style="color:#b00020">*</span></label>
        <input id="roomNumber" type="text" class="input" placeholder="" oninput="validateRoom(this)" />
        <div id="roomErr" class="error" data-i18n="errRoom">請填寫正確的房號</div>
        <div class="hint" data-i18n="roomHint">尚未 CHECK IN 請輸入0000</div>
      </div>

      <div class="field">
        <label class="label" data-i18n="labelName">貴賓姓名<span style="color:#b00020">*</span></label>
        <input id="guestName" type="text" class="input" oninput="validateName(this)" />
        <div id="nameErr" class="error" data-i18n="errName">請填寫姓名</div>
      </div>
      <div class="field">
        <label class="label" data-i18n="labelPhone">手機<span style="color:#b00020">*</span></label>
        <input id="guestPhone" type="tel" class="input" placeholder="+886921234567" oninput="validatePhone(this)" />
        <div id="phoneErr" class="error" data-i18n="errPhone">請輸入正確的手機號碼</div>
        <div class="hint" data-i18n="phoneHint">請輸入正確的手機號碼（可填寫非台灣手機號碼）</div>
      </div>
      <div class="field">
        <label class="label" data-i18n="labelEmail">信箱<span style="color:#b00020">*</span></label>
        <input id="guestEmail" type="email" class="input" placeholder="name@example.com" oninput="validateEmail(this)" />
        <div id="emailErr" class="error" data-i18n="errEmail">請填寫正確的郵箱</div>
      </div>

      <div class="actions">
        <button class="button btn-ghost" onclick="goStep(4)" data-i18n="back">返回</button>
        <button class="button btn-ghost" onclick="restart()" data-i18n="requery">重新查詢</button>
        <button class="button" type="button" onclick="toStep6()" data-i18n="next">下一步</button>
      </div>
    </section>

    <!-- Step 6：確認與送出 -->
    <section id="step6" class="card wizard-fixed" style="display:none">
      <h2 data-i18n="step6Title">確認班次資訊</h2>
      <div class="grid">
        <div class="field"><label class="label" data-i18n="labelDirection">方向</label><input id="cf_direction" class="readonly" readonly/></div>
        <div class="field"><label class="label" data-i18n="labelDate">日期</label><input id="cf_date" class="readonly" readonly/></div>
        <div class="field"><label class="label" data-i18n="labelPick">上車站點</label><input id="cf_pick" class="readonly" readonly/></div>
        <div class="field"><label class="label" data-i18n="labelDrop">下車站點</label><input id="cf_drop" class="readonly" readonly/></div>
        <div class="field"><label class="label" data-i18n="labelScheduleOnly">班次</label><input id="cf_time" class="readonly" readonly/></div>
        <div class="field"><label class="label" data-i18n="labelName">姓名</label><input id="cf_name" class="readonly" readonly/></div>
      </div>
      <div class="field">
        <label class="label" data-i18n="labelPassengers">預約人數（請選擇）<span style="color:#b00020">*</span></label>
        <select id="passengers" class="select"></select>
        <div id="passengersHint" class="hint"></div>
        <div id="passengersErr" class="error" data-i18n="errPassengers">請選擇正確的人數（不可超過可預約人數或4人）</div>
      </div>
      <div class="actions row">
        <button class="button btn-ghost" onclick="goStep(5)" data-i18n="back">返回</button>
        <button class="button" onclick="submitBooking()" data-i18n="submit">提交預約</button>
      </div>
    </section>

    <!-- 成功卡片 -->
    <section id="successCard" class="card wizard-fixed" style="display:none">
      <div id="ticketCard" class="ticket-card">
        <div class="status-pill status-booked" id="successStatusPill">✔️ 已預約</div>
        <button class="ticket-close" onclick="closeTicketToHome()" aria-label="close">✕</button>
        <div class="ticket-header"><h2 id="ticketTitle">接駁車票</h2></div>
        <div class="ticket-content">
          <div class="ticket-qr">
            <img id="qrImg" src="" alt="QR" />
          </div>
          <div class="ticket-info">
            <div class="ticket-field"><div class="ticket-label">預約編號</div><div class="ticket-value" id="t_booking"></div></div>
            <div class="ticket-field"><div class="ticket-label">日期</div><div class="ticket-value" id="t_date"></div></div>
            <div class="ticket-field"><div class="ticket-label">班次</div><div class="ticket-value" id="t_time"></div></div>
            <div class="ticket-field"><div class="ticket-label">方向</div><div class="ticket-value" id="t_dir"></div></div>
            <div class="ticket-field"><div class="ticket-label">上車</div><div class="ticket-value" id="t_pick"></div></div>
            <div class="ticket-field"><div class="ticket-label">下車</div><div class="ticket-value" id="t_drop"></div></div>
            <div class="ticket-field"><div class="ticket-label">姓名</div><div class="ticket-value" id="t_name"></div></div>
            <div class="ticket-field"><div class="ticket-label">手機</div><div class="ticket-value" id="t_phone"></div></div>
            <div class="ticket-field"><div class="ticket-label">信箱</div><div class="ticket-value" id="t_email"></div></div>
            <div class="ticket-field"><div class="ticket-label">人數</div><div class="ticket-value" id="t_pax"></div></div>
          </div>
        </div>
        <div class="ticket-actions">
          <button class="button btn-ghost" onclick="restart()">回首頁</button>
        </div>
      </div>
    </section>
  </main>

  <!-- 我的預約 -->
  <main id="check" class="page" style="display:none">
    <section id="queryBlock" class="card">
      <h2 data-i18n="queryTitle">查詢訂單（已預約/取消/修改）</h2>
      <form class="query-form" onsubmit="event.preventDefault(); onQueryOrders();">
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
          <div class="field"><label class="label" data-i18n="labelBooking">預約編號</label><input id="q_booking" class="input"/></div>
          <div class="field"><label class="label" data-i18n="labelPhone">手機</label><input id="q_phone" class="input"/></div>
          <div class="field" style="grid-column:1 / span 2"><label class="label" data-i18n="labelEmail">信箱</label><input id="q_email" class="input"/></div>
        </div>
        <div class="actions">
          <button class="button" type="submit" data-i18n="queryBtn">查詢</button>
        </div>
      </form>
    </section>

    <section id="queryDates" class="card" style="display:none">
      <h2 data-i18n="queryByDate">請選擇日期</h2>
      <div id="dateBuckets" class="grid"></div>
    </section>

    <section id="ticketsSection" class="ticket-page" style="display:none">
      <div id="ticketsContainer"></div>
    </section>
  </main>

  <!-- 查詢班次 -->
  <main id="capacity" class="page" style="display:none">
    <section class="card">
      <h2 data-i18n="capacityTitle">查詢班次</h2>
      <div class="grid" style="grid-template-columns:repeat(3,1fr); gap:10px">
        <div class="field">
          <label class="label" data-i18n="capDir">去程 / 回程</label>
          <div id="capDirBtns" class="actions"></div>
        </div>
        <div class="field">
          <label class="label" data-i18n="capDate">日期</label>
          <div id="capDateBtns" class="actions"></div>
        </div>
        <div class="field">
          <label class="label" data-i18n="capStation">站點</label>
          <div id="capStationBtns" class="actions"></div>
        </div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button class="button" onclick="loadCapacity()" data-i18n="capReload">讀取最新</button>
        <button class="button btn-ghost" onclick="clearCapFilters()" data-i18n="capClear">清除條件</button>
      </div>
    </section>
    <section id="capResult" class="card" style="display:none">
      <h2 data-i18n="capResultTitle">可預約班次（可預約人數）</h2>
      <div id="capList" class="grid"></div>
    </section>
  </main>

  <!-- 停靠站點 -->
  <main id="station" class="page station-page" style="display:none">
    <section class="card">
      <h2 data-i18n="stationTitle">停靠站點</h2>
      <p>福泰大飯店 Forte Hotel ⇄ 南港展覽館捷運站 Nangang Exhibition Center - MRT Exit 3 / 南港火車站 Nangang Train Station / LaLaport Shopping Park</p>
    </section>
  </main>

  <!-- 回官網 -->
  <main id="contact" class="page" style="display:none">
    <section class="card">
      <h2 data-i18n="contactTitle">回官網</h2>
      <div class="actions">
        <a class="button" href="https://www.forte.com.tw/hotel/branch?&unitId=FJ" target="_blank" rel="noopener">打開官網</a>
      </div>
    </section>
  </main>

  <!-- 成功動畫 -->
  <div id="successOverlay" class="success-animation" role="status" aria-live="polite" aria-hidden="true">
    <svg class="checkmark" viewBox="0 0 52 52">
      <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
      <path class="checkmark__check" fill="none" d="M14 27l7 7 16-16"/>
    </svg>
    <div id="successText" style="font-weight:900">成功</div>
  </div>

  <footer class="footer">© Forte Hotel Xizhi</footer>

  <script>
    /* ====== 常數（API） ====== */
    const API_URL = "https://booking-api-995728097341.asia-east1.run.app/api/sheet";
    const OPS_URL = "https://booking-manager-995728097341.asia-east1.run.app/api/ops";
    const QR_ORIGIN = "https://booking-manager-995728097341.asia-east1.run.app";

    /* ====== 狀態 ====== */
    const state = {
      lang: "zh",
      booking: {
        direction: null,
        date: null,
        station: null,
        time: null,
        identity: "hotel",
        checkIn: null,
        checkOut: null,
        diningDate: null,
        roomNumber: "",
        pickLocation: "福泰大飯店 Forte Hotel",
        dropLocation: "",
        name: "",
        phone: "",
        email: "",
        passengers: 1,
      },
      schedules: [],        // 由 booking-api 提供
      myOrders: [],         // 查詢結果
      capacityRows: [],     // 可預約班次(web) 原始資料
      capFilters: { dir:null, date:null, station:null },
    };

    /* ====== i18n ====== */
    const i18n = {
      zh:{
        title:"飯店服務-免費接駁車預約", brand:"飯店服務",
        navReservation:"立即預約", navCheck:"我的預約", navCapacity:"查詢班次", navStation:"停靠站點", navContact:"回官網",
        heroTitle:"免費接駁", bookNow:"立即預約",
        step1Title:"選擇方向", step2Title:"選擇日期", step3Title:"選擇站點", step4Title:"選擇班次", step5Title:"旅客資料填寫", step6Title:"確認班次資訊",
        labelDirection:"請選擇方向", labelDate:"請選擇日期", labelFixedStation:"固定站點", labelStation:"請選擇站點", labelSchedule:"請選擇班次", scheduleHint:"點選班次以繼續",
        labelIdentity:"請選擇您的身分", idHotel:"住宿貴賓", idDining:"用餐貴賓", labelCheckIn:"入住日期", labelCheckOut:"退房日期", labelDiningDate:"用餐日期", labelRoom:"房號",
        roomHint:"尚未 CHECK IN 請輸入0000", labelName:"貴賓姓名", labelPhone:"手機", labelEmail:"信箱", labelPick:"上車站點", labelDrop:"下車站點", labelScheduleOnly:"班次", labelPassengers:"預約人數（請選擇）",
        errIdentity:"請選擇您的身分", errRoom:"請填寫正確的房號", errName:"請填寫姓名", errPhone:"請輸入正確的手機號碼", errEmail:"請填寫正確的郵箱", errPassengers:"請選擇正確的人數（不可超過可預約人數或4人）",
        back:"返回", requery:"重新查詢", next:"下一步", submit:"提交預約",
        ticketTitle:"接駁車票", queryTitle:"查詢訂單（已預約/取消/修改）", queryBtn:"查詢", queryByDate:"請選擇日期",
        capacityTitle:"查詢班次", capDir:"去程 / 回程", capDate:"日期", capStation:"站點", capReload:"讀取最新", capClear:"清除條件", capResultTitle:"可預約班次（可預約人數）",
      },
      en:{ title:"Hotel Shuttle Booking", brand:"Hotel Services", navReservation:"Book Now", navCheck:"My Bookings", navCapacity:"Schedules", navStation:"Stops", navContact:"Website",
        heroTitle:"Free Shuttle", bookNow:"Book Now", step1Title:"Direction", step2Title:"Date", step3Title:"Station", step4Title:"Schedule", step5Title:"Guest Info", step6Title:"Confirm",
        labelDirection:"Direction", labelDate:"Date", labelFixedStation:"Fixed Station", labelStation:"Station", labelSchedule:"Schedule", scheduleHint:"Tap a schedule to continue",
        labelIdentity:"Identity", idHotel:"Hotel Guest", idDining:"Dining Guest", labelCheckIn:"Check-in", labelCheckOut:"Check-out", labelDiningDate:"Dining Date", labelRoom:"Room No.",
        roomHint:"If not checked in yet, enter 0000", labelName:"Name", labelPhone:"Phone", labelEmail:"Email", labelPick:"Pickup", labelDrop:"Dropoff", labelScheduleOnly:"Time", labelPassengers:"Passengers",
        errIdentity:"Select identity", errRoom:"Invalid room", errName:"Enter name", errPhone:"Enter valid phone", errEmail:"Enter valid email", errPassengers:"Select valid passengers (<=4 and <=capacity)",
        back:"Back", requery:"Restart", next:"Next", submit:"Submit",
        ticketTitle:"Shuttle Ticket", queryTitle:"Query Orders (booked/cancelled/modified)", queryBtn:"Search", queryByDate:"Pick a date",
        capacityTitle:"Schedules", capDir:"Direction", capDate:"Date", capStation:"Station", capReload:"Reload", capClear:"Clear", capResultTitle:"Available (remaining)",
      },
      ja:{ title:"送迎予約", brand:"ホテルサービス", navReservation:"今すぐ予約", navCheck:"予約確認", navCapacity:"時刻検索", navStation:"停留所", navContact:"公式サイト",
        heroTitle:"無料送迎", bookNow:"今すぐ予約", step1Title:"方向", step2Title:"日付", step3Title:"停留所", step4Title:"便", step5Title:"お客様情報", step6Title:"確認",
        labelDirection:"方向", labelDate:"日付", labelFixedStation:"固定停留所", labelStation:"停留所", labelSchedule:"便", scheduleHint:"便を選択してください",
        labelIdentity:"身分", idHotel:"宿泊", idDining:"レストラン", labelCheckIn:"チェックイン", labelCheckOut:"チェックアウト", labelDiningDate:"食事日", labelRoom:"部屋番号",
        roomHint:"未チェックインは0000", labelName:"氏名", labelPhone:"電話", labelEmail:"メール", labelPick:"乗車", labelDrop:"降車", labelScheduleOnly:"時間", labelPassengers:"人数",
        errIdentity:"身分を選択", errRoom:"部屋番号が正しくありません", errName:"氏名を入力", errPhone:"正しい電話番号を入力", errEmail:"正しいメールを入力", errPassengers:"正しい人数を選択（4人以下かつ上限以下）",
        back:"戻る", requery:"やり直す", next:"次へ", submit:"送信",
        ticketTitle:"送迎チケット", queryTitle:"予約の確認", queryBtn:"検索", queryByDate:"日付を選択",
        capacityTitle:"時刻検索", capDir:"方向", capDate:"日付", capStation:"停留所", capReload:"再読込", capClear:"クリア", capResultTitle:"予約可能（残数）",
      },
      ko:{ title:"셔틀 예약", brand:"호텔 서비스", navReservation:"지금 예약", navCheck:"예약 확인", navCapacity:"스케줄", navStation:"정류장", navContact:"웹사이트",
        heroTitle:"무료 셔틀", bookNow:"지금 예약", step1Title:"방향", step2Title:"날짜", step3Title:"정류장", step4Title:"시간", step5Title:"고객 정보", step6Title:"확인",
        labelDirection:"방향", labelDate:"날짜", labelFixedStation:"고정 정류장", labelStation:"정류장", labelSchedule:"시간", scheduleHint:"시간을 선택하세요",
        labelIdentity:"신분", idHotel:"투숙객", idDining:"식사 고객", labelCheckIn:"체크인", labelCheckOut:"체크아웃", labelDiningDate:"식사 날짜", labelRoom:"방 번호",
        roomHint:"미체크인은 0000 입력", labelName:"이름", labelPhone:"전화", labelEmail:"이메일", labelPick:"승차", labelDrop:"하차", labelScheduleOnly:"시간", labelPassengers:"인원수",
        errIdentity:"신분 선택", errRoom:"방 번호 오류", errName:"이름 입력", errPhone:"전화 입력", errEmail:"이메일 입력", errPassengers:"인원 선택(4 이하, 정원 이내)",
        back:"뒤로", requery:"다시", next:"다음", submit:"제출",
        ticketTitle:"셔틀 티켓", queryTitle:"예약 조회", queryBtn:"검색", queryByDate:"날짜 선택",
        capacityTitle:"스케줄", capDir:"방향", capDate:"날짜", capStation:"정류장", capReload:"새로고침", capClear:"초기화", capResultTitle:"예약 가능(잔여)",
      },
    };

    function t(key){ return (i18n[state.lang] && i18n[state.lang][key]) || key; }
    function onLanguageChange(v){
      state.lang = v || "zh";
      document.querySelectorAll("[data-i18n]").forEach(el=>{ const k=el.getAttribute("data-i18n"); if(k) el.textContent = t(k); });
      document.title = t("title");
    }

    /* ====== 工具 ====== */
    function maskEmail(email){
      if(!email) return "";
      const [name, domain] = email.split("@");
      const n = name.length;
      const left = name.slice(0, Math.max(1, Math.ceil(n*0.3)));
      return `${left}${"*".repeat(Math.max(3, n - left.length))}@${domain}`;
    }
    function maskPhone(p){
      if(!p) return "";
      const s = p.replace(/\D/g,"");
      if(s.length <= 4) return "*".repeat(s.length);
      return `${s.slice(0,3)}${"*".repeat(Math.max(3, s.length-6))}${s.slice(-3)}`;
    }

    // 解析「車次」字串：可能為 "'11/12 18:30" 或 "11/12 18:30" 或 含雜訊如 "<11/12 18:30"
    function parseCarDisplay(carStr){
      if(!carStr) return {mm:null, dd:null, hh:null, mi:null};
      const s = String(carStr).replace(/^['<\s]+/,"").trim();
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\s+(\d{1,2}):(\d{2})/);
      if(!m) return {mm:null, dd:null, hh:null, mi:null};
      return {mm:parseInt(m[1],10), dd:parseInt(m[2],10), hh:parseInt(m[3],10), mi:parseInt(m[4],10)};
    }

    // 以「日期欄 + 車次欄」來判斷是否過期。年份以當下為主。
    // 1月跨年特例：若現在是 1 月而車次 mm=12，則視為去年。
    function isExpired(dateIso, carDisplay){
      try{
        const {mm,dd,hh,mi} = parseCarDisplay(carDisplay);
        if(!mm || !dd) return true;
        let y = new Date().getFullYear();
        const nowMonth = (new Date()).getMonth()+1;
        if(nowMonth === 1 && mm === 12){ y = y - 1; } // 跨年特例

        // 優先採用 dateIso 的月日，若 dateIso 有效則覆寫 mm/dd
        if(dateIso && /^\d{4}-\d{2}-\d{2}$/.test(dateIso)){
          const [Y,M,D] = dateIso.split("-").map(x=>parseInt(x,10));
          if(!Number.isNaN(Y) && !Number.isNaN(M) && !Number.isNaN(D)){ y = Y; }
        }
        const iso = `${y}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}T${String(hh||0).padStart(2,"0")}:${String(mi||0).padStart(2,"0")}:00+08:00`;
        const dt = new Date(iso);
        if(Number.isNaN(dt.getTime())) return true;
        return dt.getTime() < Date.now();
      }catch(e){ return true; }
    }

    function showOverlay(txt){
      let el = document.getElementById("overlay");
      if(!el){
        el = document.createElement("div");
        el.id = "overlay";
        el.className = "overlay show";
        el.innerHTML = `<div class="overlay-card">
            <div class="spinner"></div>
            <h3 id="overlayTitle">${txt||"處理中"}</h3>
            <div id="overlayMsg" class="hint"></div>
            <div style="text-align:right;margin-top:10px">
              <button class="button btn-ghost" type="button" onclick="hideOverlay()">關閉</button>
            </div>
          </div>`;
        document.body.appendChild(el);
      }else{
        el.classList.add("show");
        document.getElementById("overlayTitle").textContent = txt || "處理中";
        document.getElementById("overlayMsg").textContent = "";
      }
    }
    function hideOverlay(){
      const el = document.getElementById("overlay");
      if(el){ el.classList.remove("show"); }
    }

    /* Back to Top 按鈕 */
    const backBtn = document.getElementById("backToTop");
    window.addEventListener("scroll", () => {
      if(window.scrollY > 180){ backBtn.style.display = "block"; } else { backBtn.style.display = "none"; }
    }, {passive:true});

    /* ====== 導覽 ====== */
    function showPage(id){
      document.querySelectorAll(".page").forEach(p=>p.style.display="none");
      document.getElementById(id).style.display = "block";
      document.querySelectorAll(".nav-links button, .mobile-tabbar button").forEach(b=>b.classList.remove("active"));
      const navIds = {reservation:["nav-reservation","m-reservation"], check:["nav-check","m-check"], capacity:["nav-capacity","m-capacity"], station:["nav-station","m-station"], contact:["nav-contact","m-contact"]};
      (navIds[id]||[]).forEach(x=>{ const el = document.getElementById(x); if(el) el.classList.add("active"); });
      window.scrollTo({top:0,behavior:"smooth"});
      if(id==="capacity" && !state.capacityRows.length){ loadCapacity(); }
    }

    /* ====== API 呼叫 ====== */
    async function fetchSheetRaw(){
      // booking-api 固定 GET /api/sheet 回傳 values[]
      const resp = await fetch(API_URL, { method:"GET" });
      if(!resp.ok){ throw new Error(`api_sheet_http_${resp.status}`); }
      return await resp.json();
    }

    async function callOps(action, data){
      const url = OPS_URL;
      const resp = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ action, data })
      });
      if(!resp.ok){
        const text = await resp.text().catch(()=> "");
        throw new Error(`ops_http_${resp.status}:${text}`);
      }
      return await resp.json();
    }

    /* ====== 預約流程 ====== */
    function startBooking(){
      showPage("reservation");
      document.getElementById("homeHero").style.display = "none";
      goStep(1);
      buildDirection();
    }

    function goStep(n){
      for(let i=1;i<=6;i++){ document.getElementById("step"+i).style.display = (i===n)?"block":"none"; }
      window.scrollTo({top:0,behavior:"smooth"});
    }
    function restart(){
      // 清空並回首頁
      state.booking = {
        direction:null,date:null,station:null,time:null,identity:"hotel",checkIn:null,checkOut:null,diningDate:null,roomNumber:"",
        pickLocation:"福泰大飯店 Forte Hotel",dropLocation:"",name:"",phone:"",email:"",passengers:1
      };
      document.getElementById("homeHero").style.display = "block";
      document.getElementById("successCard").style.display = "none";
      goStep(0);
      showPage("reservation");
    }
    function onIdentityChange(){
      const v = document.getElementById("identitySelect").value;
      state.booking.identity = v;
      const showHotel = v==="hotel";
      document.getElementById("hotelDates").style.display = showHotel? "block":"none";
      document.getElementById("hotelDates2").style.display = showHotel? "block":"none";
      document.getElementById("roomNumberDiv").style.display = showHotel? "block":"none";
      document.getElementById("diningDateDiv").style.display = showHotel? "none":"block";
    }

    function buildDirection(){
      const wrap = document.getElementById("directionList");
      wrap.innerHTML = "";
      ["去程","回程"].forEach(dir => {
        const btn = document.createElement("button");
        btn.className = "opt-btn";
        btn.textContent = dir;
        btn.onclick = () => {
          state.booking.direction = dir;
          goStep(2);
          buildDates();
        };
        wrap.appendChild(btn);
      });
    }

    async function buildDates(){
      // 直接從 booking-api 拉 values，並把日期去重
      showOverlay("讀取班次");
      try{
        const values = await fetchSheetRaw();
        // 解析標頭
        const headers = values[0] || [];
        const idxDir = headers.indexOf("去程 / 回程");
        const idxDate = headers.indexOf("日期");
        const idxStation = headers.indexOf("站點");
        if(idxDir<0 || idxDate<0 || idxStation<0){ throw new Error("sheet_header_missing"); }
        state.schedules = values.slice(1).map(r=>({
          dir: r[idxDir]||"", date: r[idxDate]||"", time: r[headers.indexOf("班次")]||"", station: r[idxStation]||"",
          remainText: r[headers.indexOf("可預約人數")]||""
        }));
        const set = new Set(state.schedules.filter(x=>x.dir===state.booking.direction).map(x=>x.date));
        const dates = Array.from(set).sort();
        const wrap = document.getElementById("dateList"); wrap.innerHTML="";
        dates.forEach(d=>{
          const b = document.createElement("button");
          b.className="opt-btn";
          b.textContent = d;
          b.onclick = ()=>{ state.booking.date = d; goStep(3); buildStations(); };
          wrap.appendChild(b);
        });
      }catch(e){
        alert("載入班次失敗");
      }finally{ hideOverlay(); }
    }

    function buildStations(){
      const wrap = document.getElementById("stationList"); wrap.innerHTML = "";
      const stations = Array.from(new Set(state.schedules.filter(x=>x.dir===state.booking.direction && x.date===state.booking.date).map(x=>x.station)));
      stations.forEach(s=>{
        const b = document.createElement("button");
        b.className="opt-btn";
        b.textContent = s;
        b.onclick = ()=>{ state.booking.station = s; goStep(4); buildTimes(); };
        wrap.appendChild(b);
      });
    }

    function buildTimes(){
      const wrap = document.getElementById("scheduleList"); wrap.innerHTML = "";
      const rows = state.schedules.filter(x=>x.dir===state.booking.direction && x.date===state.booking.date && x.station===state.booking.station);
      rows.forEach(r=>{
        const b = document.createElement("button");
        b.className="opt-btn";
        b.textContent = `${r.time}（${r.remainText}）`;
        b.onclick = ()=>{
          state.booking.time = r.time;
          // 設置上下車點
          if(state.booking.direction==="去程"){ state.booking.pickLocation="福泰大飯店 Forte Hotel"; state.booking.dropLocation = state.booking.station; }
          else { state.booking.pickLocation = state.booking.station; state.booking.dropLocation = "福泰大飯店 Forte Hotel"; }
          goStep(5);
        };
        wrap.appendChild(b);
      });
    }

    function validateRoom(inp){
      const ok = /^[0-9]{1,5}$/.test(inp.value) || inp.value==="0000";
      document.getElementById("roomErr").style.display = ok? "none":"block";
      return ok;
    }
    function validateName(inp){
      const ok = inp.value.trim().length >= 1;
      document.getElementById("nameErr").style.display = ok? "none":"block";
      return ok;
    }
    function validatePhone(inp){
      const ok = inp.value.trim().length >= 6;
      document.getElementById("phoneErr").style.display = ok? "none":"block";
      return ok;
    }
    function validateEmail(inp){
      const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(inp.value);
      document.getElementById("emailErr").style.display = ok? "none":"block";
      return ok;
    }

    function toStep6(){
      const idv = document.getElementById("identitySelect").value;
      if(idv==="hotel"){
        if(!validateRoom(document.getElementById("roomNumber"))) return;
        if(!document.getElementById("checkInDate").value || !document.getElementById("checkOutDate").value){ alert("請填入住與退房日期"); return; }
      }else{
        if(!document.getElementById("diningDate").value){ alert("請填用餐日期"); return; }
      }
      if(!validateName(document.getElementById("guestName"))) return;
      if(!validatePhone(document.getElementById("guestPhone"))) return;
      if(!validateEmail(document.getElementById("guestEmail"))) return;

      state.booking.identity = idv;
      state.booking.name = document.getElementById("guestName").value.trim();
      state.booking.phone = document.getElementById("guestPhone").value.trim();
      state.booking.email = document.getElementById("guestEmail").value.trim();
      state.booking.roomNumber = document.getElementById("roomNumber").value.trim();
      state.booking.checkIn = document.getElementById("checkInDate").value || null;
      state.booking.checkOut = document.getElementById("checkOutDate").value || null;
      state.booking.diningDate = document.getElementById("diningDate").value || null;

      // 填入確認欄
      document.getElementById("cf_direction").value = state.booking.direction;
      document.getElementById("cf_date").value = state.booking.date;
      document.getElementById("cf_pick").value = state.booking.pickLocation;
      document.getElementById("cf_drop").value = state.booking.dropLocation;
      document.getElementById("cf_time").value = state.booking.time;
      document.getElementById("cf_name").value = state.booking.name;

      // 預設 1~4 或依可預約剩餘
      const paxSel = document.getElementById("passengers");
      paxSel.innerHTML = "";
      for(let i=1;i<=4;i++){ const opt=document.createElement("option"); opt.value=String(i); opt.textContent=String(i); paxSel.appendChild(opt); }
      paxSel.value = "1";
      goStep(6);
    }

    async function submitBooking(){
      // 一次性寫入；先讓後端檢查容量，再 append；成功後才顯示票與 QR
      try{
        showOverlay("提交中");
        const payload = {
          direction: state.booking.direction,
          date: state.booking.date,
          station: state.booking.station,
          time: state.booking.time,
          identity: state.booking.identity,
          checkIn: state.booking.checkIn,
          checkOut: state.booking.checkOut,
          diningDate: state.booking.diningDate,
          roomNumber: state.booking.roomNumber,
          name: state.booking.name,
          phone: state.booking.phone,
          email: state.booking.email,
          passengers: parseInt(document.getElementById("passengers").value, 10),
          pickLocation: state.booking.pickLocation,
          dropLocation: state.booking.dropLocation,
        };
        const res = await callOps("book", payload);
        hideOverlay();

        // 顯示成功卡片
        document.getElementById("homeHero").style.display = "none";
        document.getElementById("successCard").style.display = "block";
        document.getElementById("t_booking").textContent = res.booking_id || "";
        document.getElementById("t_date").textContent = payload.date;
        document.getElementById("t_time").textContent = payload.time;
        document.getElementById("t_dir").textContent = payload.direction;
        document.getElementById("t_pick").textContent = payload.pickLocation;
        document.getElementById("t_drop").textContent = payload.dropLocation;
        document.getElementById("t_name").textContent = payload.name;
        document.getElementById("t_phone").textContent = maskPhone(payload.phone);
        document.getElementById("t_email").textContent = maskEmail(payload.email);
        document.getElementById("t_pax").textContent = String(payload.passengers);

        // 延後載入 QR（避免先產生導致與表單不同步）
        const qrUrl = res.qr_url;
        if(qrUrl){ document.getElementById("qrImg").src = qrUrl; }

        // 成功動畫
        const anim = document.getElementById("successOverlay");
        document.getElementById("successText").textContent = "成功";
        anim.classList.add("show");
        setTimeout(()=>anim.classList.remove("show"), 3200);
      }catch(e){
        hideOverlay();
        alert(`提交失敗：${e.message||e}`);
      }
    }

    function closeTicketToHome(){ document.getElementById("successCard").style.display="none"; showPage("reservation"); }

    /* ====== 我的預約：查詢與呈現 ====== */
    async function onQueryOrders(){
      const booking_id = document.getElementById("q_booking").value.trim();
      const phone = document.getElementById("q_phone").value.trim();
      const email = document.getElementById("q_email").value.trim();

      if(!booking_id && !phone && !email){ alert("請至少輸入一項條件"); return; }

      showOverlay("查詢中");
      try{
        const res = await callOps("query", { booking_id, phone, email });
        state.myOrders = Array.isArray(res)? res: [];
        hideOverlay();

        // 隱藏整個查詢區塊
        document.getElementById("queryBlock").style.display = "none";

        // 依日期分組，顯示日期清單「YYYY/MM/DD（x 筆）」
        const buckets = {};
        for(const r of state.myOrders){
          const date = r["日期"];
          if(!buckets[date]) buckets[date] = [];
          buckets[date].push(r);
        }
        const list = Object.entries(buckets).sort((a,b)=> a[0].localeCompare(b[0]));
        const wrap = document.getElementById("dateBuckets"); wrap.innerHTML = "";
        for(const [date, rows] of list){
          const cnt = rows.length;
          const btn = document.createElement("button");
          btn.className = "opt-btn";
          btn.textContent = `${date}（有 ${cnt} 筆預約）`;
          btn.onclick = ()=> showTicketsForDate(date, rows);
          wrap.appendChild(btn);
        }
        document.getElementById("queryDates").style.display = "block";
        document.getElementById("ticketsSection").style.display = "none";
      }catch(e){
        hideOverlay();
        alert(`查詢失敗：${e.message||e}`);
      }
    }

    function showTicketsForDate(date, rows){
      // 先把取消放最後，其餘依班次時間排序由近到遠
      const valid = [];
      const cancelled = [];
      for(const r of rows){
        const st = (r["預約狀態"]||"").toLowerCase();
        if(st.includes("取消")) cancelled.push(r);
        else valid.push(r);
      }
      const parseTime = (r)=>{
        const t = r["班次"] || r["車次"];
        const {mm,dd,hh,mi} = parseCarDisplay(t);
        return (hh||0)*60 + (mi||0);
      };
      valid.sort((a,b)=> parseTime(a) - parseTime(b));

      const ordered = [...valid, ...cancelled];
      const wrap = document.getElementById("ticketsContainer");
      wrap.innerHTML = "";

      for(const r of ordered){
        const car = r["車次"] || "";
        const ex = isExpired(r["日期"], car);
        const title = (()=>{
          const p = parseCarDisplay(car);
          const y = (new Date(r["日期"]||Date.now())).getFullYear();
          if(!p.mm) return "接駁車票";
          return `${y}/${String(p.mm).padStart(2,"0")}/${String(p.dd).padStart(2,"0")}  ${String(p.hh||0).padStart(2,"0")}:${String(p.mi||0).padStart(2,"0")}`;
        })();
        const pillClass = ex? "status-expired" : ((r["預約狀態"]||"").includes("取消")? "status-cancelled":"status-booked");
        const ticket = document.createElement("div");
        ticket.className = "ticket-card"+(ex?" expired":"");
        ticket.innerHTML = `
          <div class="status-pill ${pillClass}">${r["預約狀態"]||""}</div>
          <div class="ticket-header"><h2>${title}</h2></div>
          <div class="ticket-content">
            <div class="ticket-qr">
              ${r["QRCode編碼"]? `<img src="${QR_ORIGIN}/api/qr/${encodeURIComponent(r["QRCode編碼"])}" alt="QR"/>` : "<div class='hint'>無 QR</div>"}
            </div>
            <div class="ticket-info">
              <div class="ticket-field"><div class="ticket-label">預約編號</div><div class="ticket-value">${r["預約編號"]||""}</div></div>
              <div class="ticket-field"><div class="ticket-label">日期</div><div class="ticket-value">${r["日期"]||""}</div></div>
              <div class="ticket-field"><div class="ticket-label">班次</div><div class="ticket-value">${r["班次"]||""}</div></div>
              <div class="ticket-field"><div class="ticket-label">方向</div><div class="ticket-value">${r["往返"]||""}</div></div>
              <div class="ticket-field"><div class="ticket-label">上車</div><div class="ticket-value">${r["上車地點"]||""}</div></div>
              <div class="ticket-field"><div class="ticket-label">下車</div><div class="ticket-value">${r["下車地點"]||""}</div></div>
              <div class="ticket-field"><div class="ticket-label">姓名</div><div class="ticket-value">${(r["姓名"]||"")}</div></div>
              <div class="ticket-field"><div class="ticket-label">手機</div><div class="ticket-value">${maskPhone(r["手機"]||"")}</div></div>
              <div class="ticket-field"><div class="ticket-label">信箱</div><div class="ticket-value">${maskEmail(r["信箱"]||"")}</div></div>
              <div class="ticket-field"><div class="ticket-label">人數</div><div class="ticket-value">${r["預約人數"]||"1"}</div></div>
            </div>
          </div>`;
        wrap.appendChild(ticket);
      }

      document.getElementById("ticketsSection").style.display = "block";
      document.getElementById("queryDates").style.display = "none";
      window.scrollTo({top:0,behavior:"smooth"});
    }

    /* ====== 查詢班次（capacity） ====== */
    function clearCapFilters(){ state.capFilters = {dir:null, date:null, station:null}; renderCapFilters(); renderCapList(); }
    function renderCapFilters(){
      const dirs = Array.from(new Set(state.capacityRows.map(r=>r.dir))).filter(Boolean);
      const dates = Array.from(new Set(state.capacityRows.map(r=>r.date))).filter(Boolean).sort();
      const stations = Array.from(new Set(state.capacityRows.map(r=>r.station))).filter(Boolean);

      function buildBtns(containerId, items, key){
        const el = document.getElementById(containerId); el.innerHTML="";
        items.forEach(item=>{
          const btn = document.createElement("button");
          btn.className = "button btn-ghost";
          btn.textContent = item;
          if(state.capFilters[key]===item) btn.classList.add("active");
          btn.onclick = ()=>{ state.capFilters[key] = (state.capFilters[key]===item? null: item); renderCapFilters(); renderCapList(); };
          el.appendChild(btn);
        });
      }
      buildBtns("capDirBtns", dirs, "dir");
      buildBtns("capDateBtns", dates, "date");
      buildBtns("capStationBtns", stations, "station");
    }

    function renderCapList(){
      const list = document.getElementById("capList"); list.innerHTML="";
      let rows = state.capacityRows.slice();
      const f = state.capFilters;
      if(f.dir) rows = rows.filter(r=>r.dir===f.dir);
      if(f.date) rows = rows.filter(r=>r.date===f.date);
      if(f.station) rows = rows.filter(r=>r.station===f.station);
      rows.sort((a,b)=> (a.date.localeCompare(b.date)) || (a.time.localeCompare(b.time)) || (a.station.localeCompare(b.station)) );

      if(!rows.length){
        document.getElementById("capResult").style.display = "none";
        return;
      }
      document.getElementById("capResult").style.display = "block";
      for(const r of rows){
        const div = document.createElement("div");
        div.className="card";
        div.innerHTML = `<div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div><b>${r.dir}</b>｜${r.date}｜<b>${r.time}</b><br/>${r.station}</div>
          <div style="font-weight:900">${r.remainText}</div>
        </div>`;
        list.appendChild(div);
      }
    }

    async function loadCapacity(){
      try{
        showOverlay("載入中");
        const values = await fetchSheetRaw();
        const headers = values[0] || [];
        const idxDir = headers.indexOf("去程 / 回程");
        const idxDate = headers.indexOf("日期");
        const idxTime = headers.indexOf("班次");
        const idxStation = headers.indexOf("站點");
        const idxRemain = headers.indexOf("可預約人數");
        if([idxDir,idxDate,idxTime,idxStation,idxRemain].some(i=>i<0)){ throw new Error("sheet_header_missing"); }
        state.capacityRows = values.slice(1).map(r=> ({
          dir: r[idxDir]||"", date: r[idxDate]||"", time: r[idxTime]||"", station: r[idxStation]||"",
          remainText: r[idxRemain]||""
        }));
        renderCapFilters();
        renderCapList();
      }catch(e){
        alert("載入失敗");
      }finally{ hideOverlay(); }
    }

    // 初始化
    onLanguageChange("zh");
  </script>
</body>
</html>
