## 需求回應
- 出車主班次時間：支援雙格式匹配（`YYYY/MM/DD HH:MM` 與 `YYYY-MM-DD HH:MM(:SS)`），以日期＋時間在《車次管理(櫃台)》A6/B6欄位對應；已有多格式解析函式，出車開始時使用規範化匹配。
- 乘客地圖刷新：預設 5 分鐘一次，並提供右上角「手動刷新」按鈕；不再採 5–10 秒高頻輪詢，避免觸發後端 API 的高流量。
- 後端存取：出車開始時由後端將 stops＋polyline 寫入 Firebase；乘客地圖讀 Firebase（REST 或 Web SDK），只在刷新事件發生時取資料。

## 日期格式匹配（後端）
- 規範化函式：將 APP 傳入主班次字串轉為 `YYYY/MM/DD` 與 `HH:MM` 兩種候選值；以 `A`（日期）與 `B`（班次/時間）雙鍵匹配。
- 異常處理：容忍秒數與不同分隔符（`/`、`-`），並在找不到時回傳友善錯誤。

## 乘客地圖刷新策略
- 預設：啟動後每 5 分鐘觸發一次刷新（`setInterval(5min)`）。
- 手動刷新：右上角按鈕即刻拉取最新 `/driver_location` 與 `/trip/{trip_id}/route`。
- 資料來源：
  - 位置：讀 Firebase（後端已寫入 `/driver_location`），避免高頻打 API。
  - 路線：讀 Firebase `/trip/{trip_id}/route`（出車開始時生成）。

## Uber風格地圖渲染（乘客HTML）
- 樣式要點：
  - 車輛標記：圓形或車型圖標，帶陰影與 “pulse” 動畫（新位置時平滑移動）。
  - 站點標記：五站以不同顏色與編號顯示，含「福泰(回)」。
  - 路線 polyline：主線為粗藍色，已行走段以更深或高亮色顯示；未行走段為淡色。
  - 視野控制：初次載入 `fitBounds` 包含全部站點；位置更新時在原範圍內 `panTo`。
- 技術方案：
  - 使用 Google Maps JavaScript API 的 `DirectionsService` 生成功能性路線（waypoints 來自 H:K 欄位勾選邏輯）。
  - 將生成的 polyline（坐標序列）寫入 Firebase；乘客端只負責渲染與高亮進度（不重複計算路線）。
  - 高亮進度：用最近位置在 polyline 上找最近點，截取前半段作為高亮線，後半段為淡色線。
- 失敗容忍：Directions API 失敗時，後端回退為「直線連接停靠站」；乘客端仍正常顯示。

## 系統設置 UI 調整
- 面板加寬：設定面板寬度至 320–360px 以避免文字截斷。
- 排序（強制）：使用者切換 → 清單模式 → 發車通知 → 字體大小 → 資料更新 → 問題回報 → 恢復原廠 → 版本更新 → 開發選項（置底；10連點+5833）。

## 實作步驟
1. 後端：在出車開始端點中，強化主班次規範化匹配；生成路線並寫入 Firebase。
2. 乘客HTML：
   - 新增右上角「手動刷新」按鈕，預設 5 分鐘自動刷新。
   - 從 Firebase讀取 route+location 檔，渲染站點與 polyline，高亮已行走段。
3. APP：將 GPS 上傳頻率調整為可設定（預設 5 分鐘，最低 1 分鐘），綁定出車開關與角色。
4. UI：加寬系統設置面板；調整排序與「角色切換」改名為「使用者切換」。

## 驗證
- 出車開始：能在《車次管理(櫃台)》正確匹配班次（雙格式）；Firebase 出現 `/trip/{trip_id}/route`。
- 乘客地圖：預設 5 分鐘自動刷新；手動刷新可即時更新；路線與站點呈現一致且高亮進度正確。
- UI：左側面板不截字；排序與命名符合需求；開發選項置底且需密碼解鎖。

請確認此方案；核准後我會立即開始實作以上調整。